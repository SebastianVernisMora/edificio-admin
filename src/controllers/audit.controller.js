import { handleControllerError } from '../utils/errorHandler.js';\nimport { \n  getAuditLogs, \n  getAuditLogsByUser, \n  getAuditStats\n} from '../utils/auditLog.js';\nimport { getTodayAccessLogs, getCacheStats, clearPermissionsCache } from '../middleware/auth.js';\n\n/**\n * GET /api/audit/logs\n * Obtiene logs de auditoría por fecha\n * Requiere permisos de administrador\n */\nexport const obtenerLogs = async (req, res) => {\n  try {\n    const { date, limit } = req.query;\n    const logs = getAuditLogs(date, parseInt(limit) || 100);\n    \n    res.json({\n      ok: true,\n      data: {\n        logs,\n        total: logs.length,\n        date: date || new Date().toISOString().split('T')[0]\n      }\n    });\n  } catch (error) {\n    return handleControllerError(error, res, 'obtenerLogs');\n  }\n};\n\n/**\n * GET /api/audit/logs/user/:userId\n * Obtiene logs de auditoría de un usuario específico\n * Requiere permisos de administrador\n */\nexport const obtenerLogsPorUsuario = async (req, res) => {\n  try {\n    const { userId } = req.params;\n    const { days } = req.query;\n    \n    const logs = getAuditLogsByUser(parseInt(userId), parseInt(days) || 7);\n    \n    res.json({\n      ok: true,\n      data: {\n        logs,\n        total: logs.length,\n        userId: parseInt(userId),\n        days: parseInt(days) || 7\n      }\n    });\n  } catch (error) {\n    return handleControllerError(error, res, 'obtenerLogsPorUsuario');\n  }\n};\n\n/**\n * GET /api/audit/stats\n * Obtiene estadísticas de auditoría\n * Requiere permisos de administrador\n */\nexport const obtenerEstadisticas = async (req, res) => {\n  try {\n    const { days } = req.query;\n    const stats = getAuditStats(parseInt(days) || 30);\n    \n    res.json({\n      ok: true,\n      data: stats\n    });\n  } catch (error) {\n    return handleControllerError(error, res, 'obtenerEstadisticas');\n  }\n};\n\n/**\n * GET /api/audit/access-logs\n * Obtiene logs de acceso del día actual\n * Requiere permisos de administrador\n */\nexport const obtenerLogsAcceso = async (req, res) => {\n  try {\n    const logs = getTodayAccessLogs();\n    \n    res.json({\n      ok: true,\n      data: {\n        logs,\n        total: logs.length,\n        date: new Date().toISOString().split('T')[0]\n      }\n    });\n  } catch (error) {\n    return handleControllerError(error, res, 'obtenerLogsAcceso');\n  }\n};\n\n/**\n * GET /api/audit/cache-stats\n * Obtiene estadísticas del cache de permisos\n * Requiere permisos de administrador\n */\nexport const obtenerEstadisticasCache = async (req, res) => {\n  try {\n    const stats = getCacheStats();\n    \n    res.json({\n      ok: true,\n      data: stats\n    });\n  } catch (error) {\n    return handleControllerError(error, res, 'obtenerEstadisticasCache');\n  }\n};\n\n/**\n * POST /api/audit/clear-cache\n * Limpia el cache de permisos\n * Requiere permisos de administrador\n */\nexport const limpiarCache = async (req, res) => {\n  try {\n    const { userId } = req.body;\n    \n    clearPermissionsCache(userId);\n    \n    res.json({\n      ok: true,\n      msg: userId ? \n        `Cache limpiado para usuario ${userId}` : \n        'Cache de permisos limpiado completamente'\n    });\n  } catch (error) {\n    return handleControllerError(error, res, 'limpiarCache');\n  }\n};\n\n/**\n * GET /api/audit/activity-summary\n * Obtiene resumen de actividad reciente\n * Requiere permisos de administrador\n */\nexport const obtenerResumenActividad = async (req, res) => {\n  try {\n    const auditStats = getAuditStats(7); // Últimos 7 días\n    const accessLogs = getTodayAccessLogs();\n    const cacheStats = getCacheStats();\n    \n    // Contar accesos por tipo hoy\n    const accessSummary = accessLogs.reduce((acc, log) => {\n      acc[log.type] = (acc[log.type] || 0) + 1;\n      return acc;\n    }, {});\n    \n    // Usuarios más activos\n    const activeUsers = Object.entries(auditStats.eventsByUser)\n      .sort(([,a], [,b]) => b - a)\n      .slice(0, 5)\n      .map(([user, count]) => ({ user, count }));\n    \n    res.json({\n      ok: true,\n      data: {\n        summary: {\n          totalAuditEvents: auditStats.totalEvents,\n          totalAccessEvents: accessLogs.length,\n          cacheSize: cacheStats.size,\n          activeUsers: activeUsers.length\n        },\n        accessSummary,\n        activeUsers,\n        recentActivity: auditStats.recentActivity.slice(0, 5),\n        cacheStats: {\n          size: cacheStats.size,\n          avgAge: cacheStats.entries.length > 0 ? \n            cacheStats.entries.reduce((sum, entry) => sum + entry.age, 0) / cacheStats.entries.length : 0\n        }\n      }\n    });\n  } catch (error) {\n    return handleControllerError(error, res, 'obtenerResumenActividad');\n  }\n};\n