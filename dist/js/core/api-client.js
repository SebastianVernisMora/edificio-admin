var n=class{constructor(){this.baseURL="/api",this.cache=new Map,this.requestQueue=new Map,this.defaultOptions={timeout:1e4,retries:2,cache:!0}}async request(t,e={}){let o={...this.defaultOptions,...e},a=e.method||"GET",s=`${a}:${t}:${JSON.stringify(e.body||{})}`;if(o.cache&&a==="GET"&&this.cache.has(s)){let r=this.cache.get(s);if(Date.now()-r.timestamp<6e4)return console.log("\u{1F4E6} Cache hit:",t),r.data}if(this.requestQueue.has(s))return console.log("\u23F3 Request deduplication:",t),this.requestQueue.get(s);let i=this._executeRequest(t,o,s);this.requestQueue.set(s,i);try{let r=await i;return a==="GET"&&o.cache&&this.cache.set(s,{data:r,timestamp:Date.now()}),r}finally{this.requestQueue.delete(s)}}async _executeRequest(t,e,o,a=1){let s=localStorage.getItem("edificio_token"),i=new AbortController,r=setTimeout(()=>i.abort(),e.timeout);try{let c=await fetch(`${this.baseURL}${t}`,{method:e.method||"GET",headers:{"Content-Type":"application/json","x-auth-token":s,...e.headers},body:e.body?JSON.stringify(e.body):void 0,signal:i.signal});if(clearTimeout(r),!c.ok){if(c.status===401)throw localStorage.removeItem("edificio_token"),localStorage.removeItem("edificio_user"),window.location.href="/",new Error("Sesi\xF3n expirada");let h=await c.json();throw new Error(h.msg||`Error ${c.status}`)}return await c.json()}catch(c){if(clearTimeout(r),a<e.retries&&c.name==="AbortError")return console.warn(`\u26A0\uFE0F Retry attempt ${a+1} for ${t}`),await this._delay(1e3*a),this._executeRequest(t,e,o,a+1);throw c}}async prefetchCommon(){console.log("\u{1F680} Prefetching common data...");try{await Promise.all([this.request("/fondos"),this.request("/cuotas?limit=10"),this.request("/anuncios?activo=true&limit=5")]),console.log("\u2705 Common data prefetched")}catch(t){console.error("\u274C Prefetch error:",t)}}clearCache(t=null){if(t)for(let[e]of this.cache)e.includes(t)&&this.cache.delete(e);else this.cache.clear()}_delay(t){return new Promise(e=>setTimeout(e,t))}async login(t,e){return this.request("/auth/login",{method:"POST",body:{email:t,password:e},cache:!1})}async verifyAuth(){return this.request("/auth/verify",{cache:!1})}async getCuotas(t={}){let e=new URLSearchParams(t).toString();return this.request(`/cuotas${e?"?"+e:""}`)}async createCuota(t){let e=await this.request("/cuotas",{method:"POST",body:t,cache:!1});return this.clearCache("cuotas"),e}async updateCuota(t,e){let o=await this.request(`/cuotas/${t}`,{method:"PUT",body:e,cache:!1});return this.clearCache("cuotas"),o}async verificarVencimientos(){let t=await this.request("/cuotas/verificar-vencimientos",{method:"POST",cache:!1});return this.clearCache("cuotas"),t}async getGastos(t={}){let e=new URLSearchParams(t).toString();return this.request(`/gastos${e?"?"+e:""}`)}async createGasto(t){let e=await this.request("/gastos",{method:"POST",body:t,cache:!1});return this.clearCache("gastos"),this.clearCache("fondos"),e}async getFondos(){return this.request("/fondos")}async transferirFondos(t){let e=await this.request("/fondos/transferencia",{method:"POST",body:t,cache:!1});return this.clearCache("fondos"),e}async getAnuncios(t={}){let e=new URLSearchParams(t).toString();return this.request(`/anuncios${e?"?"+e:""}`)}async createAnuncio(t){let e=await this.request("/anuncios",{method:"POST",body:t,cache:!1});return this.clearCache("anuncios"),e}async getParcialidades(t={}){let e=new URLSearchParams(t).toString();return this.request(`/parcialidades${e?"?"+e:""}`)}async createParcialidad(t){let e=await this.request("/parcialidades",{method:"POST",body:t,cache:!1});return this.clearCache("parcialidades"),e}},u=new n,d=u;export{d as default};
