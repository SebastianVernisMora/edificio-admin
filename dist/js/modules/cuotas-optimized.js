var u=class{constructor(){this.baseURL="/api",this.cache=new Map,this.requestQueue=new Map,this.defaultOptions={timeout:1e4,retries:2,cache:!0}}async request(t,e={}){let a={...this.defaultOptions,...e},s=e.method||"GET",o=`${s}:${t}:${JSON.stringify(e.body||{})}`;if(a.cache&&s==="GET"&&this.cache.has(o)){let i=this.cache.get(o);if(Date.now()-i.timestamp<6e4)return console.log("\u{1F4E6} Cache hit:",t),i.data}if(this.requestQueue.has(o))return console.log("\u23F3 Request deduplication:",t),this.requestQueue.get(o);let c=this._executeRequest(t,a,o);this.requestQueue.set(o,c);try{let i=await c;return s==="GET"&&a.cache&&this.cache.set(o,{data:i,timestamp:Date.now()}),i}finally{this.requestQueue.delete(o)}}async _executeRequest(t,e,a,s=1){let o=localStorage.getItem("edificio_token"),c=new AbortController,i=setTimeout(()=>c.abort(),e.timeout);try{let n=await fetch(`${this.baseURL}${t}`,{method:e.method||"GET",headers:{"Content-Type":"application/json","x-auth-token":o,...e.headers},body:e.body?JSON.stringify(e.body):void 0,signal:c.signal});if(clearTimeout(i),!n.ok){if(n.status===401)throw localStorage.removeItem("edificio_token"),localStorage.removeItem("edificio_user"),window.location.href="/",new Error("Sesi\xF3n expirada");let g=await n.json();throw new Error(g.msg||`Error ${n.status}`)}return await n.json()}catch(n){if(clearTimeout(i),s<e.retries&&n.name==="AbortError")return console.warn(`\u26A0\uFE0F Retry attempt ${s+1} for ${t}`),await this._delay(1e3*s),this._executeRequest(t,e,a,s+1);throw n}}async prefetchCommon(){console.log("\u{1F680} Prefetching common data...");try{await Promise.all([this.request("/fondos"),this.request("/cuotas?limit=10"),this.request("/anuncios?activo=true&limit=5")]),console.log("\u2705 Common data prefetched")}catch(t){console.error("\u274C Prefetch error:",t)}}clearCache(t=null){if(t)for(let[e]of this.cache)e.includes(t)&&this.cache.delete(e);else this.cache.clear()}_delay(t){return new Promise(e=>setTimeout(e,t))}async login(t,e){return this.request("/auth/login",{method:"POST",body:{email:t,password:e},cache:!1})}async verifyAuth(){return this.request("/auth/verify",{cache:!1})}async getCuotas(t={}){let e=new URLSearchParams(t).toString();return this.request(`/cuotas${e?"?"+e:""}`)}async createCuota(t){let e=await this.request("/cuotas",{method:"POST",body:t,cache:!1});return this.clearCache("cuotas"),e}async updateCuota(t,e){let a=await this.request(`/cuotas/${t}`,{method:"PUT",body:e,cache:!1});return this.clearCache("cuotas"),a}async verificarVencimientos(){let t=await this.request("/cuotas/verificar-vencimientos",{method:"POST",cache:!1});return this.clearCache("cuotas"),t}async getGastos(t={}){let e=new URLSearchParams(t).toString();return this.request(`/gastos${e?"?"+e:""}`)}async createGasto(t){let e=await this.request("/gastos",{method:"POST",body:t,cache:!1});return this.clearCache("gastos"),this.clearCache("fondos"),e}async getFondos(){return this.request("/fondos")}async transferirFondos(t){let e=await this.request("/fondos/transferencia",{method:"POST",body:t,cache:!1});return this.clearCache("fondos"),e}async getAnuncios(t={}){let e=new URLSearchParams(t).toString();return this.request(`/anuncios${e?"?"+e:""}`)}async createAnuncio(t){let e=await this.request("/anuncios",{method:"POST",body:t,cache:!1});return this.clearCache("anuncios"),e}async getParcialidades(t={}){let e=new URLSearchParams(t).toString();return this.request(`/parcialidades${e?"?"+e:""}`)}async createParcialidad(t){let e=await this.request("/parcialidades",{method:"POST",body:t,cache:!1});return this.clearCache("parcialidades"),e}},y=new u,l=y;var d=class{constructor(){this.state={user:null,cuotas:[],gastos:[],fondos:null,anuncios:[],parcialidades:[],loading:{},errors:{}},this.listeners=new Map,this.history=[],this.maxHistory=50}get(t){return this.state[t]}set(t,e,a=!0){let s=this.state[t];this.state[t]=e,a&&(this.history.push({key:t,oldValue:s,newValue:e,timestamp:Date.now()}),this.history.length>this.maxHistory&&this.history.shift()),this.notify(t,e,s),this.notify("*",{key:t,value:e,oldValue:s})}setMultiple(t){Object.entries(t).forEach(([e,a])=>{this.set(e,a,!1)}),this.notify("batch",t)}subscribe(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>{this.listeners.get(t).delete(e)}}notify(t,e,a){this.listeners.has(t)&&this.listeners.get(t).forEach(s=>{try{s(e,a)}catch(o){console.error(`Error in listener for ${t}:`,o)}})}setLoading(t,e){this.state.loading[t]=e,this.notify("loading",this.state.loading)}setError(t,e){this.state.errors[t]=e,this.notify("errors",this.state.errors),setTimeout(()=>{this.state.errors[t]===e&&(delete this.state.errors[t],this.notify("errors",this.state.errors))},5e3)}clearError(t){delete this.state.errors[t],this.notify("errors",this.state.errors)}getState(){return{...this.state}}reset(){Object.entries({user:null,cuotas:[],gastos:[],fondos:null,anuncios:[],parcialidades:[],loading:{},errors:{}}).forEach(([e,a])=>{this.set(e,a)}),this.history=[]}getHistory(t=null){return t?this.history.filter(e=>e.key===t):[...this.history]}computed(t,e){let a=()=>{let s=t.map(o=>this.get(o));return e(...s)};return t.forEach(s=>{this.subscribe(s,a)}),a()}debug(){console.group("\u{1F50D} State Manager Debug"),console.log("State:",this.state),console.log("Listeners:",this.listeners),console.log("History:",this.history),console.groupEnd()}},f=new d;typeof window<"u"&&(window.__STATE__=f);var r=f;var h=class{constructor(){this.initialized=!1,this.filters={mes:"",anio:new Date().getFullYear().toString(),estado:"TODOS",departamento:""},this.unsubscribers=[]}async init(){if(this.initialized){console.log("Cuotas module already initialized");return}console.log("\u{1F3AC} Initializing Cuotas module..."),this.setupEventListeners(),this.subscribeToState(),await this.loadInitialData(),this.initialized=!0,console.log("\u2705 Cuotas module initialized")}setupEventListeners(){document.addEventListener("click",this.handleClick.bind(this)),document.addEventListener("change",this.handleChange.bind(this)),document.addEventListener("submit",this.handleSubmit.bind(this))}subscribeToState(){let t=r.subscribe("cuotas",s=>{this.renderCuotasTable(s)}),e=r.subscribe("loading",s=>{this.updateLoadingState(s.cuotas)}),a=r.subscribe("errors",s=>{s.cuotas&&this.showError(s.cuotas)});this.unsubscribers.push(t,e,a)}async loadInitialData(){await this.loadCuotas()}async loadCuotas(){r.setLoading("cuotas",!0);try{let t={};this.filters.mes&&(t.mes=this.filters.mes),this.filters.anio&&(t.anio=this.filters.anio),this.filters.estado!=="TODOS"&&(t.estado=this.filters.estado),this.filters.departamento&&(t.departamento=this.filters.departamento);let e=await l.getCuotas(t);r.set("cuotas",e.cuotas||[])}catch(t){r.setError("cuotas",t.message),console.error("Error loading cuotas:",t)}finally{r.setLoading("cuotas",!1)}}handleClick(t){let e=t.target;if(e.id==="nueva-cuota-btn")t.preventDefault(),this.showNuevaCuotaModal();else if(e.id==="verificar-vencimientos-btn")t.preventDefault(),this.verificarVencimientos();else if(e.closest('[data-action="validar"]')){t.preventDefault();let s=e.closest('[data-action="validar"]').dataset.id;this.showValidarPagoModal(s)}else(e.classList.contains("close")||e.classList.contains("modal-cancel"))&&(t.preventDefault(),this.closeModals())}handleChange(t){let e=t.target;["cuotas-mes","cuotas-a\xF1o","cuotas-estado"].includes(e.id)&&this.updateFilters()}handleSubmit(t){let e=t.target;e.id==="cuota-form"?(t.preventDefault(),this.submitNuevaCuota(e)):e.id==="validar-pago-form"&&(t.preventDefault(),this.submitValidarPago(e))}updateFilters(){this.filters={mes:document.getElementById("cuotas-mes")?.value||"",anio:document.getElementById("cuotas-a\xF1o")?.value||"",estado:document.getElementById("cuotas-estado")?.value||"TODOS",departamento:document.getElementById("cuotas-departamento")?.value||""},console.log("Filters updated:",this.filters),this.loadCuotas()}renderCuotasTable(t){let e=document.querySelector("#cuotas-table tbody");if(!e)return;if(!t||t.length===0){e.innerHTML='<tr><td colspan="7" class="text-center">No hay cuotas registradas</td></tr>';return}let a=document.createDocumentFragment();t.forEach(s=>{let o=this.createCuotaRow(s);a.appendChild(o)}),e.innerHTML="",e.appendChild(a)}createCuotaRow(t){let e=document.createElement("tr"),a="";switch(t.estado){case"PAGADO":a="badge-success";break;case"PENDIENTE":a="badge-warning";break;case"VENCIDO":a="badge-danger";break}let s=new Date(t.fechaVencimiento),o=t.fechaPago?new Date(t.fechaPago).toLocaleDateString("es-MX"):"-";return e.innerHTML=`
      <td>${t.departamento}</td>
      <td>${t.mes} ${t.anio}</td>
      <td>$${t.monto.toLocaleString()}</td>
      <td><span class="badge ${a}">${t.estado}</span></td>
      <td>${s.toLocaleDateString("es-MX")}</td>
      <td>${o}</td>
      <td>
        <button class="btn btn-sm btn-primary" data-action="validar" data-id="${t.id}">
          Validar
        </button>
      </td>
    `,e}showNuevaCuotaModal(){let t=document.getElementById("cuota-modal");if(!t)return;let e=document.getElementById("cuota-form");if(e){e.reset(),document.getElementById("cuota-id").value="",document.getElementById("cuota-modal-title").textContent="Nueva Cuota";let a=new Date,s=new Date(a.getFullYear(),a.getMonth()+1,0);document.getElementById("cuota-vencimiento").value=s.toISOString().split("T")[0]}t.style.display="block"}showValidarPagoModal(t){let e=document.getElementById("validar-pago-modal");if(!e)return;let s=r.get("cuotas").find(o=>o.id===parseInt(t));if(!s){alert("Cuota no encontrada");return}document.getElementById("validar-cuota-id").value=s.id,document.getElementById("validar-estado").value=s.estado,document.getElementById("validar-fecha-pago").value=s.fechaPago||"",document.getElementById("validar-comprobante").value=s.comprobante||"",e.style.display="block"}async submitNuevaCuota(t){let e=new FormData(t),a={mes:e.get("mes"),anio:parseInt(e.get("anio")),monto:parseFloat(e.get("monto")),departamento:e.get("departamento"),fechaVencimiento:e.get("vencimiento")};try{await l.createCuota(a),this.closeModals(),this.loadCuotas(),alert("Cuota creada exitosamente")}catch(s){alert(`Error: ${s.message}`)}}async submitValidarPago(t){let e=new FormData(t),a=e.get("cuota-id"),s={estado:e.get("estado"),fechaPago:e.get("fecha-pago"),comprobante:e.get("comprobante")};try{await l.updateCuota(a,s),this.closeModals(),this.loadCuotas(),alert("Pago validado exitosamente")}catch(o){alert(`Error: ${o.message}`)}}async verificarVencimientos(){if(confirm("\xBFVerificar vencimientos de todas las cuotas?"))try{let t=await l.verificarVencimientos();alert(`Vencimientos verificados:
${t.actualizadas} cuotas actualizadas`),this.loadCuotas()}catch(t){alert(`Error: ${t.message}`)}}closeModals(){document.querySelectorAll(".modal").forEach(t=>{t.style.display="none"})}updateLoadingState(t){let e=document.getElementById("cuotas-section");e&&(t?e.classList.add("loading"):e.classList.remove("loading"))}showError(t){console.error("Cuotas error:",t)}cleanup(){console.log("\u{1F9F9} Cleaning up Cuotas module..."),this.unsubscribers.forEach(t=>t()),this.unsubscribers=[],this.initialized=!1}},C=new h;export{C as default};
