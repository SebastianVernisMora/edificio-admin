var l=class{constructor(){this.baseURL="/api",this.cache=new Map,this.requestQueue=new Map,this.defaultOptions={timeout:1e4,retries:2,cache:!0}}async request(t,e={}){let s={...this.defaultOptions,...e},o=e.method||"GET",r=`${o}:${t}:${JSON.stringify(e.body||{})}`;if(s.cache&&o==="GET"&&this.cache.has(r)){let i=this.cache.get(r);if(Date.now()-i.timestamp<6e4)return console.log("\u{1F4E6} Cache hit:",t),i.data}if(this.requestQueue.has(r))return console.log("\u23F3 Request deduplication:",t),this.requestQueue.get(r);let c=this._executeRequest(t,s,r);this.requestQueue.set(r,c);try{let i=await c;return o==="GET"&&s.cache&&this.cache.set(r,{data:i,timestamp:Date.now()}),i}finally{this.requestQueue.delete(r)}}async _executeRequest(t,e,s,o=1){let r=localStorage.getItem("edificio_token"),c=new AbortController,i=setTimeout(()=>c.abort(),e.timeout);try{let n=await fetch(`${this.baseURL}${t}`,{method:e.method||"GET",headers:{"Content-Type":"application/json","x-auth-token":r,...e.headers},body:e.body?JSON.stringify(e.body):void 0,signal:c.signal});if(clearTimeout(i),!n.ok){if(n.status===401)throw localStorage.removeItem("edificio_token"),localStorage.removeItem("edificio_user"),window.location.href="/",new Error("Sesi\xF3n expirada");let g=await n.json();throw new Error(g.msg||`Error ${n.status}`)}return await n.json()}catch(n){if(clearTimeout(i),o<e.retries&&n.name==="AbortError")return console.warn(`\u26A0\uFE0F Retry attempt ${o+1} for ${t}`),await this._delay(1e3*o),this._executeRequest(t,e,s,o+1);throw n}}async prefetchCommon(){console.log("\u{1F680} Prefetching common data...");try{await Promise.all([this.request("/fondos"),this.request("/cuotas?limit=10"),this.request("/anuncios?activo=true&limit=5")]),console.log("\u2705 Common data prefetched")}catch(t){console.error("\u274C Prefetch error:",t)}}clearCache(t=null){if(t)for(let[e]of this.cache)e.includes(t)&&this.cache.delete(e);else this.cache.clear()}_delay(t){return new Promise(e=>setTimeout(e,t))}async login(t,e){return this.request("/auth/login",{method:"POST",body:{email:t,password:e},cache:!1})}async verifyAuth(){return this.request("/auth/verify",{cache:!1})}async getCuotas(t={}){let e=new URLSearchParams(t).toString();return this.request(`/cuotas${e?"?"+e:""}`)}async createCuota(t){let e=await this.request("/cuotas",{method:"POST",body:t,cache:!1});return this.clearCache("cuotas"),e}async updateCuota(t,e){let s=await this.request(`/cuotas/${t}`,{method:"PUT",body:e,cache:!1});return this.clearCache("cuotas"),s}async verificarVencimientos(){let t=await this.request("/cuotas/verificar-vencimientos",{method:"POST",cache:!1});return this.clearCache("cuotas"),t}async getGastos(t={}){let e=new URLSearchParams(t).toString();return this.request(`/gastos${e?"?"+e:""}`)}async createGasto(t){let e=await this.request("/gastos",{method:"POST",body:t,cache:!1});return this.clearCache("gastos"),this.clearCache("fondos"),e}async getFondos(){return this.request("/fondos")}async transferirFondos(t){let e=await this.request("/fondos/transferencia",{method:"POST",body:t,cache:!1});return this.clearCache("fondos"),e}async getAnuncios(t={}){let e=new URLSearchParams(t).toString();return this.request(`/anuncios${e?"?"+e:""}`)}async createAnuncio(t){let e=await this.request("/anuncios",{method:"POST",body:t,cache:!1});return this.clearCache("anuncios"),e}async getParcialidades(t={}){let e=new URLSearchParams(t).toString();return this.request(`/parcialidades${e?"?"+e:""}`)}async createParcialidad(t){let e=await this.request("/parcialidades",{method:"POST",body:t,cache:!1});return this.clearCache("parcialidades"),e}},y=new l,d=y;var h=class{constructor(){this.state={user:null,cuotas:[],gastos:[],fondos:null,anuncios:[],parcialidades:[],loading:{},errors:{}},this.listeners=new Map,this.history=[],this.maxHistory=50}get(t){return this.state[t]}set(t,e,s=!0){let o=this.state[t];this.state[t]=e,s&&(this.history.push({key:t,oldValue:o,newValue:e,timestamp:Date.now()}),this.history.length>this.maxHistory&&this.history.shift()),this.notify(t,e,o),this.notify("*",{key:t,value:e,oldValue:o})}setMultiple(t){Object.entries(t).forEach(([e,s])=>{this.set(e,s,!1)}),this.notify("batch",t)}subscribe(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>{this.listeners.get(t).delete(e)}}notify(t,e,s){this.listeners.has(t)&&this.listeners.get(t).forEach(o=>{try{o(e,s)}catch(r){console.error(`Error in listener for ${t}:`,r)}})}setLoading(t,e){this.state.loading[t]=e,this.notify("loading",this.state.loading)}setError(t,e){this.state.errors[t]=e,this.notify("errors",this.state.errors),setTimeout(()=>{this.state.errors[t]===e&&(delete this.state.errors[t],this.notify("errors",this.state.errors))},5e3)}clearError(t){delete this.state.errors[t],this.notify("errors",this.state.errors)}getState(){return{...this.state}}reset(){Object.entries({user:null,cuotas:[],gastos:[],fondos:null,anuncios:[],parcialidades:[],loading:{},errors:{}}).forEach(([e,s])=>{this.set(e,s)}),this.history=[]}getHistory(t=null){return t?this.history.filter(e=>e.key===t):[...this.history]}computed(t,e){let s=()=>{let o=t.map(r=>this.get(r));return e(...o)};return t.forEach(o=>{this.subscribe(o,s)}),s()}debug(){console.group("\u{1F50D} State Manager Debug"),console.log("State:",this.state),console.log("Listeners:",this.listeners),console.log("History:",this.history),console.groupEnd()}},m=new h;typeof window<"u"&&(window.__STATE__=m);var a=m;var u=class{constructor(){this.initialized=!1,this.fondos=null,this.movimientos=[],this.unsubscribers=[]}async init(){if(this.initialized){console.log("Fondos module already initialized");return}console.log("\u{1F3AC} Initializing Fondos module..."),this.setupEventListeners(),this.subscribeToState(),await this.loadInitialData(),this.initialized=!0,console.log("\u2705 Fondos module initialized")}setupEventListeners(){document.addEventListener("click",this.handleClick.bind(this)),document.addEventListener("submit",this.handleSubmit.bind(this))}subscribeToState(){let t=a.subscribe("fondos",o=>{this.fondos=o,this.renderFondos(o)}),e=a.subscribe("loading",o=>{this.updateLoadingState(o.fondos)}),s=a.subscribe("errors",o=>{o.fondos&&this.showError(o.fondos)});this.unsubscribers.push(t,e,s)}async loadInitialData(){await this.loadFondos()}async loadFondos(){a.setLoading("fondos",!0);try{let t=await d.getFondos();a.set("fondos",t.fondos||t),t.movimientos&&(this.movimientos=t.movimientos,this.renderMovimientos(t.movimientos))}catch(t){a.setError("fondos",t.message)}finally{a.setLoading("fondos",!1)}}handleClick(t){let e=t.target;e.id==="transferir-fondos-btn"?(t.preventDefault(),this.showTransferirModal()):(e.classList.contains("close")||e.classList.contains("modal-cancel"))&&(t.preventDefault(),this.closeModals())}handleSubmit(t){let e=t.target;e.id==="transferir-form"&&(t.preventDefault(),this.submitTransferencia(e))}renderFondos(t){if(!t)return;this.updateFondoCard("ahorro-acumulado",t.ahorroAcumulado),this.updateFondoCard("gastos-mayores",t.gastosMayores),this.updateFondoCard("dinero-operacional",t.dineroOperacional);let e=(t.ahorroAcumulado||0)+(t.gastosMayores||0)+(t.dineroOperacional||0);this.updateFondoCard("patrimonio-total-fondos",e);let s=document.getElementById("fondos-actualizacion");s&&(s.textContent=new Date().toLocaleDateString("es-MX"))}updateFondoCard(t,e){let s=document.getElementById(t);s&&(s.textContent=`$${(e||0).toLocaleString()}`)}renderMovimientos(t){let e=document.querySelector("#movimientos-table tbody");if(!e)return;if(!t||t.length===0){e.innerHTML='<tr><td colspan="6" class="text-center">No hay movimientos registrados</td></tr>';return}let s=document.createDocumentFragment();t.slice(-20).reverse().forEach(r=>{let c=this.createMovimientoRow(r);s.appendChild(c)}),e.innerHTML="",e.appendChild(s)}createMovimientoRow(t){let e=document.createElement("tr"),s=new Date(t.fecha).toLocaleDateString("es-MX"),o=t.tipo||"transferencia",r=o==="ingreso"?"text-success":o==="egreso"?"text-danger":"";return e.innerHTML=`
      <td>${s}</td>
      <td class="${r}">${o.toUpperCase()}</td>
      <td>${this.formatFondoName(t.origen)}</td>
      <td>${this.formatFondoName(t.destino)}</td>
      <td>$${t.monto.toLocaleString()}</td>
      <td>${t.descripcion||"-"}</td>
    `,e}formatFondoName(t){return{ahorroAcumulado:"Ahorro Acumulado",gastosMayores:"Gastos Mayores",dineroOperacional:"Dinero Operacional"}[t]||t||"-"}showTransferirModal(){let t=document.getElementById("transferir-modal");if(!t)return;let e=document.getElementById("transferir-form");e&&e.reset(),t.style.display="block"}async submitTransferencia(t){let e=new FormData(t),s={origen:e.get("origen"),destino:e.get("destino"),monto:parseFloat(e.get("monto")),descripcion:e.get("descripcion")||""};if(s.origen===s.destino){alert("El fondo origen y destino no pueden ser el mismo");return}if(s.monto<=0){alert("El monto debe ser mayor a 0");return}let o=a.get("fondos");if(o&&o[s.origen]<s.monto){alert("Saldo insuficiente en el fondo origen");return}try{await d.transferirFondos(s),alert("Transferencia realizada exitosamente"),this.closeModals(),this.loadFondos()}catch(r){alert(`Error: ${r.message}`)}}closeModals(){document.querySelectorAll(".modal").forEach(t=>{t.style.display="none"})}updateLoadingState(t){let e=document.getElementById("fondos-section");e&&(t?e.classList.add("loading"):e.classList.remove("loading"))}showError(t){console.error("Fondos error:",t)}cleanup(){console.log("\u{1F9F9} Cleaning up Fondos module..."),this.unsubscribers.forEach(t=>t()),this.unsubscribers=[],this.initialized=!1}},E=new u;export{E as default};
