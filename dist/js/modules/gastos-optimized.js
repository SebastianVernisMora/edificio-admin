var d=class{constructor(){this.baseURL="/api",this.cache=new Map,this.requestQueue=new Map,this.defaultOptions={timeout:1e4,retries:2,cache:!0}}async request(t,e={}){let s={...this.defaultOptions,...e},a=e.method||"GET",o=`${a}:${t}:${JSON.stringify(e.body||{})}`;if(s.cache&&a==="GET"&&this.cache.has(o)){let i=this.cache.get(o);if(Date.now()-i.timestamp<6e4)return console.log("\u{1F4E6} Cache hit:",t),i.data}if(this.requestQueue.has(o))return console.log("\u23F3 Request deduplication:",t),this.requestQueue.get(o);let l=this._executeRequest(t,s,o);this.requestQueue.set(o,l);try{let i=await l;return a==="GET"&&s.cache&&this.cache.set(o,{data:i,timestamp:Date.now()}),i}finally{this.requestQueue.delete(o)}}async _executeRequest(t,e,s,a=1){let o=localStorage.getItem("edificio_token"),l=new AbortController,i=setTimeout(()=>l.abort(),e.timeout);try{let n=await fetch(`${this.baseURL}${t}`,{method:e.method||"GET",headers:{"Content-Type":"application/json","x-auth-token":o,...e.headers},body:e.body?JSON.stringify(e.body):void 0,signal:l.signal});if(clearTimeout(i),!n.ok){if(n.status===401)throw localStorage.removeItem("edificio_token"),localStorage.removeItem("edificio_user"),window.location.href="/",new Error("Sesi\xF3n expirada");let f=await n.json();throw new Error(f.msg||`Error ${n.status}`)}return await n.json()}catch(n){if(clearTimeout(i),a<e.retries&&n.name==="AbortError")return console.warn(`\u26A0\uFE0F Retry attempt ${a+1} for ${t}`),await this._delay(1e3*a),this._executeRequest(t,e,s,a+1);throw n}}async prefetchCommon(){console.log("\u{1F680} Prefetching common data...");try{await Promise.all([this.request("/fondos"),this.request("/cuotas?limit=10"),this.request("/anuncios?activo=true&limit=5")]),console.log("\u2705 Common data prefetched")}catch(t){console.error("\u274C Prefetch error:",t)}}clearCache(t=null){if(t)for(let[e]of this.cache)e.includes(t)&&this.cache.delete(e);else this.cache.clear()}_delay(t){return new Promise(e=>setTimeout(e,t))}async login(t,e){return this.request("/auth/login",{method:"POST",body:{email:t,password:e},cache:!1})}async verifyAuth(){return this.request("/auth/verify",{cache:!1})}async getCuotas(t={}){let e=new URLSearchParams(t).toString();return this.request(`/cuotas${e?"?"+e:""}`)}async createCuota(t){let e=await this.request("/cuotas",{method:"POST",body:t,cache:!1});return this.clearCache("cuotas"),e}async updateCuota(t,e){let s=await this.request(`/cuotas/${t}`,{method:"PUT",body:e,cache:!1});return this.clearCache("cuotas"),s}async verificarVencimientos(){let t=await this.request("/cuotas/verificar-vencimientos",{method:"POST",cache:!1});return this.clearCache("cuotas"),t}async getGastos(t={}){let e=new URLSearchParams(t).toString();return this.request(`/gastos${e?"?"+e:""}`)}async createGasto(t){let e=await this.request("/gastos",{method:"POST",body:t,cache:!1});return this.clearCache("gastos"),this.clearCache("fondos"),e}async getFondos(){return this.request("/fondos")}async transferirFondos(t){let e=await this.request("/fondos/transferencia",{method:"POST",body:t,cache:!1});return this.clearCache("fondos"),e}async getAnuncios(t={}){let e=new URLSearchParams(t).toString();return this.request(`/anuncios${e?"?"+e:""}`)}async createAnuncio(t){let e=await this.request("/anuncios",{method:"POST",body:t,cache:!1});return this.clearCache("anuncios"),e}async getParcialidades(t={}){let e=new URLSearchParams(t).toString();return this.request(`/parcialidades${e?"?"+e:""}`)}async createParcialidad(t){let e=await this.request("/parcialidades",{method:"POST",body:t,cache:!1});return this.clearCache("parcialidades"),e}},y=new d,c=y;var h=class{constructor(){this.state={user:null,cuotas:[],gastos:[],fondos:null,anuncios:[],parcialidades:[],loading:{},errors:{}},this.listeners=new Map,this.history=[],this.maxHistory=50}get(t){return this.state[t]}set(t,e,s=!0){let a=this.state[t];this.state[t]=e,s&&(this.history.push({key:t,oldValue:a,newValue:e,timestamp:Date.now()}),this.history.length>this.maxHistory&&this.history.shift()),this.notify(t,e,a),this.notify("*",{key:t,value:e,oldValue:a})}setMultiple(t){Object.entries(t).forEach(([e,s])=>{this.set(e,s,!1)}),this.notify("batch",t)}subscribe(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>{this.listeners.get(t).delete(e)}}notify(t,e,s){this.listeners.has(t)&&this.listeners.get(t).forEach(a=>{try{a(e,s)}catch(o){console.error(`Error in listener for ${t}:`,o)}})}setLoading(t,e){this.state.loading[t]=e,this.notify("loading",this.state.loading)}setError(t,e){this.state.errors[t]=e,this.notify("errors",this.state.errors),setTimeout(()=>{this.state.errors[t]===e&&(delete this.state.errors[t],this.notify("errors",this.state.errors))},5e3)}clearError(t){delete this.state.errors[t],this.notify("errors",this.state.errors)}getState(){return{...this.state}}reset(){Object.entries({user:null,cuotas:[],gastos:[],fondos:null,anuncios:[],parcialidades:[],loading:{},errors:{}}).forEach(([e,s])=>{this.set(e,s)}),this.history=[]}getHistory(t=null){return t?this.history.filter(e=>e.key===t):[...this.history]}computed(t,e){let s=()=>{let a=t.map(o=>this.get(o));return e(...a)};return t.forEach(a=>{this.subscribe(a,s)}),s()}debug(){console.group("\u{1F50D} State Manager Debug"),console.log("State:",this.state),console.log("Listeners:",this.listeners),console.log("History:",this.history),console.groupEnd()}},m=new h;typeof window<"u"&&(window.__STATE__=m);var r=m;var u=class{constructor(){this.initialized=!1,this.filters={mes:new Date().getMonth()+1,anio:new Date().getFullYear(),categoria:"TODOS"},this.unsubscribers=[]}async init(){if(this.initialized){console.log("Gastos module already initialized");return}console.log("\u{1F3AC} Initializing Gastos module..."),this.setupEventListeners(),this.subscribeToState(),await this.loadInitialData(),this.initialized=!0,console.log("\u2705 Gastos module initialized")}setupEventListeners(){document.addEventListener("click",this.handleClick.bind(this)),document.addEventListener("change",this.handleChange.bind(this)),document.addEventListener("submit",this.handleSubmit.bind(this))}subscribeToState(){let t=r.subscribe("gastos",a=>{this.renderGastosTable(a)}),e=r.subscribe("loading",a=>{this.updateLoadingState(a.gastos)}),s=r.subscribe("errors",a=>{a.gastos&&this.showError(a.gastos)});this.unsubscribers.push(t,e,s)}async loadInitialData(){await Promise.all([this.loadGastos(),this.loadFondosForDropdown()])}async loadGastos(){r.setLoading("gastos",!0);try{let t={};this.filters.mes&&(t.mes=this.filters.mes),this.filters.anio&&(t.anio=this.filters.anio),this.filters.categoria!=="TODOS"&&(t.categoria=this.filters.categoria);let e=await c.getGastos(t);r.set("gastos",e.gastos||[])}catch(t){r.setError("gastos",t.message)}finally{r.setLoading("gastos",!1)}}async loadFondosForDropdown(){try{let t=await c.getFondos();r.set("fondos",t.fondos||t)}catch(t){console.error("Error loading fondos:",t)}}handleClick(t){let e=t.target;if(e.id==="nuevo-gasto-btn")t.preventDefault(),this.showNuevoGastoModal();else if(e.closest('[data-action="edit-gasto"]')){t.preventDefault();let a=e.closest('[data-action="edit-gasto"]').dataset.id;this.editGasto(a)}else if(e.closest('[data-action="delete-gasto"]')){t.preventDefault();let a=e.closest('[data-action="delete-gasto"]').dataset.id;this.deleteGasto(a)}else(e.classList.contains("close")||e.classList.contains("modal-cancel"))&&(t.preventDefault(),this.closeModals())}handleChange(t){let e=t.target;["gastos-mes","gastos-a\xF1o","gastos-categoria"].includes(e.id)&&this.updateFilters()}handleSubmit(t){let e=t.target;e.id==="gasto-form"&&(t.preventDefault(),this.submitGasto(e))}updateFilters(){this.filters={mes:document.getElementById("gastos-mes")?.value||"",anio:document.getElementById("gastos-a\xF1o")?.value||"",categoria:document.getElementById("gastos-categoria")?.value||"TODOS"},console.log("Filters updated:",this.filters),this.loadGastos()}renderGastosTable(t){let e=document.querySelector("#gastos-table tbody");if(!e)return;if(!t||t.length===0){e.innerHTML='<tr><td colspan="6" class="text-center">No hay gastos registrados</td></tr>';return}let s=document.createDocumentFragment();t.forEach(a=>{let o=this.createGastoRow(a);s.appendChild(o)}),e.innerHTML="",e.appendChild(s)}createGastoRow(t){let e=document.createElement("tr"),s=new Date(t.fecha).toLocaleDateString("es-MX"),a=this.getCategoriaClass(t.categoria);return e.innerHTML=`
      <td>${s}</td>
      <td>${t.concepto}</td>
      <td>$${t.monto.toLocaleString()}</td>
      <td><span class="badge ${a}">${t.categoria}</span></td>
      <td>${t.proveedor||"-"}</td>
      <td>
        <button class="btn btn-sm btn-secondary" data-action="edit-gasto" data-id="${t.id}">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger" data-action="delete-gasto" data-id="${t.id}">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `,e}getCategoriaClass(t){return{MANTENIMIENTO:"badge-info",SERVICIOS:"badge-primary",REPARACIONES:"badge-warning",ADMINISTRATIVO:"badge-secondary",OTROS:"badge-light"}[t]||"badge-secondary"}showNuevoGastoModal(){let t=document.getElementById("gasto-modal");if(!t)return;let e=document.getElementById("gasto-form");if(e){e.reset(),document.getElementById("gasto-id").value="",document.getElementById("gasto-modal-title").textContent="Nuevo Gasto";let s=new Date().toISOString().split("T")[0];document.getElementById("gasto-fecha").value=s}t.style.display="block"}editGasto(t){let s=r.get("gastos").find(o=>o.id===parseInt(t));if(!s){alert("Gasto no encontrado");return}let a=document.getElementById("gasto-modal");a&&(document.getElementById("gasto-id").value=s.id,document.getElementById("gasto-concepto").value=s.concepto,document.getElementById("gasto-monto").value=s.monto,document.getElementById("gasto-categoria").value=s.categoria,document.getElementById("gasto-proveedor").value=s.proveedor||"",document.getElementById("gasto-fecha").value=s.fecha.split("T")[0],document.getElementById("gasto-fondo").value=s.fondo||"dineroOperacional",document.getElementById("gasto-comprobante").value=s.comprobante||"",document.getElementById("gasto-notas").value=s.notas||"",document.getElementById("gasto-modal-title").textContent="Editar Gasto",a.style.display="block")}async deleteGasto(t){if(confirm("\xBFEst\xE1 seguro de eliminar este gasto?"))try{await c.request(`/gastos/${t}`,{method:"DELETE",cache:!1}),alert("Gasto eliminado exitosamente"),this.loadGastos(),this.loadFondosForDropdown()}catch(e){alert(`Error: ${e.message}`)}}async submitGasto(t){let e=new FormData(t),s=e.get("gasto-id"),a={concepto:e.get("concepto"),monto:parseFloat(e.get("monto")),categoria:e.get("categoria"),proveedor:e.get("proveedor"),fecha:e.get("fecha"),fondo:e.get("fondo"),comprobante:e.get("comprobante"),notas:e.get("notas")};try{s?(await c.request(`/gastos/${s}`,{method:"PUT",body:a,cache:!1}),alert("Gasto actualizado exitosamente")):(await c.createGasto(a),alert("Gasto creado exitosamente")),this.closeModals(),this.loadGastos(),this.loadFondosForDropdown()}catch(o){alert(`Error: ${o.message}`)}}closeModals(){document.querySelectorAll(".modal").forEach(t=>{t.style.display="none"})}updateLoadingState(t){let e=document.getElementById("gastos-section");e&&(t?e.classList.add("loading"):e.classList.remove("loading"))}showError(t){console.error("Gastos error:",t)}cleanup(){console.log("\u{1F9F9} Cleaning up Gastos module..."),this.unsubscribers.forEach(t=>t()),this.unsubscribers=[],this.initialized=!1}},S=new u;export{S as default};
