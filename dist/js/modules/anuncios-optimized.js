var l=class{constructor(){this.baseURL="/api",this.cache=new Map,this.requestQueue=new Map,this.defaultOptions={timeout:1e4,retries:2,cache:!0}}async request(t,e={}){let i={...this.defaultOptions,...e},s=e.method||"GET",n=`${s}:${t}:${JSON.stringify(e.body||{})}`;if(i.cache&&s==="GET"&&this.cache.has(n)){let o=this.cache.get(n);if(Date.now()-o.timestamp<6e4)return console.log("\u{1F4E6} Cache hit:",t),o.data}if(this.requestQueue.has(n))return console.log("\u23F3 Request deduplication:",t),this.requestQueue.get(n);let c=this._executeRequest(t,i,n);this.requestQueue.set(n,c);try{let o=await c;return s==="GET"&&i.cache&&this.cache.set(n,{data:o,timestamp:Date.now()}),o}finally{this.requestQueue.delete(n)}}async _executeRequest(t,e,i,s=1){let n=localStorage.getItem("edificio_token"),c=new AbortController,o=setTimeout(()=>c.abort(),e.timeout);try{let r=await fetch(`${this.baseURL}${t}`,{method:e.method||"GET",headers:{"Content-Type":"application/json","x-auth-token":n,...e.headers},body:e.body?JSON.stringify(e.body):void 0,signal:c.signal});if(clearTimeout(o),!r.ok){if(r.status===401)throw localStorage.removeItem("edificio_token"),localStorage.removeItem("edificio_user"),window.location.href="/",new Error("Sesi\xF3n expirada");let g=await r.json();throw new Error(g.msg||`Error ${r.status}`)}return await r.json()}catch(r){if(clearTimeout(o),s<e.retries&&r.name==="AbortError")return console.warn(`\u26A0\uFE0F Retry attempt ${s+1} for ${t}`),await this._delay(1e3*s),this._executeRequest(t,e,i,s+1);throw r}}async prefetchCommon(){console.log("\u{1F680} Prefetching common data...");try{await Promise.all([this.request("/fondos"),this.request("/cuotas?limit=10"),this.request("/anuncios?activo=true&limit=5")]),console.log("\u2705 Common data prefetched")}catch(t){console.error("\u274C Prefetch error:",t)}}clearCache(t=null){if(t)for(let[e]of this.cache)e.includes(t)&&this.cache.delete(e);else this.cache.clear()}_delay(t){return new Promise(e=>setTimeout(e,t))}async login(t,e){return this.request("/auth/login",{method:"POST",body:{email:t,password:e},cache:!1})}async verifyAuth(){return this.request("/auth/verify",{cache:!1})}async getCuotas(t={}){let e=new URLSearchParams(t).toString();return this.request(`/cuotas${e?"?"+e:""}`)}async createCuota(t){let e=await this.request("/cuotas",{method:"POST",body:t,cache:!1});return this.clearCache("cuotas"),e}async updateCuota(t,e){let i=await this.request(`/cuotas/${t}`,{method:"PUT",body:e,cache:!1});return this.clearCache("cuotas"),i}async verificarVencimientos(){let t=await this.request("/cuotas/verificar-vencimientos",{method:"POST",cache:!1});return this.clearCache("cuotas"),t}async getGastos(t={}){let e=new URLSearchParams(t).toString();return this.request(`/gastos${e?"?"+e:""}`)}async createGasto(t){let e=await this.request("/gastos",{method:"POST",body:t,cache:!1});return this.clearCache("gastos"),this.clearCache("fondos"),e}async getFondos(){return this.request("/fondos")}async transferirFondos(t){let e=await this.request("/fondos/transferencia",{method:"POST",body:t,cache:!1});return this.clearCache("fondos"),e}async getAnuncios(t={}){let e=new URLSearchParams(t).toString();return this.request(`/anuncios${e?"?"+e:""}`)}async createAnuncio(t){let e=await this.request("/anuncios",{method:"POST",body:t,cache:!1});return this.clearCache("anuncios"),e}async getParcialidades(t={}){let e=new URLSearchParams(t).toString();return this.request(`/parcialidades${e?"?"+e:""}`)}async createParcialidad(t){let e=await this.request("/parcialidades",{method:"POST",body:t,cache:!1});return this.clearCache("parcialidades"),e}},y=new l,u=y;var d=class{constructor(){this.state={user:null,cuotas:[],gastos:[],fondos:null,anuncios:[],parcialidades:[],loading:{},errors:{}},this.listeners=new Map,this.history=[],this.maxHistory=50}get(t){return this.state[t]}set(t,e,i=!0){let s=this.state[t];this.state[t]=e,i&&(this.history.push({key:t,oldValue:s,newValue:e,timestamp:Date.now()}),this.history.length>this.maxHistory&&this.history.shift()),this.notify(t,e,s),this.notify("*",{key:t,value:e,oldValue:s})}setMultiple(t){Object.entries(t).forEach(([e,i])=>{this.set(e,i,!1)}),this.notify("batch",t)}subscribe(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>{this.listeners.get(t).delete(e)}}notify(t,e,i){this.listeners.has(t)&&this.listeners.get(t).forEach(s=>{try{s(e,i)}catch(n){console.error(`Error in listener for ${t}:`,n)}})}setLoading(t,e){this.state.loading[t]=e,this.notify("loading",this.state.loading)}setError(t,e){this.state.errors[t]=e,this.notify("errors",this.state.errors),setTimeout(()=>{this.state.errors[t]===e&&(delete this.state.errors[t],this.notify("errors",this.state.errors))},5e3)}clearError(t){delete this.state.errors[t],this.notify("errors",this.state.errors)}getState(){return{...this.state}}reset(){Object.entries({user:null,cuotas:[],gastos:[],fondos:null,anuncios:[],parcialidades:[],loading:{},errors:{}}).forEach(([e,i])=>{this.set(e,i)}),this.history=[]}getHistory(t=null){return t?this.history.filter(e=>e.key===t):[...this.history]}computed(t,e){let i=()=>{let s=t.map(n=>this.get(n));return e(...s)};return t.forEach(s=>{this.subscribe(s,i)}),i()}debug(){console.group("\u{1F50D} State Manager Debug"),console.log("State:",this.state),console.log("Listeners:",this.listeners),console.log("History:",this.history),console.groupEnd()}},f=new d;typeof window<"u"&&(window.__STATE__=f);var a=f;var h=class{constructor(){this.initialized=!1,this.filters={tipo:"TODOS"},this.unsubscribers=[]}async init(){if(this.initialized){console.log("Anuncios module already initialized");return}console.log("\u{1F3AC} Initializing Anuncios module..."),this.setupEventListeners(),this.subscribeToState(),await this.loadInitialData(),this.initialized=!0,console.log("\u2705 Anuncios module initialized")}setupEventListeners(){document.addEventListener("click",this.handleClick.bind(this)),document.addEventListener("change",this.handleChange.bind(this)),document.addEventListener("submit",this.handleSubmit.bind(this))}subscribeToState(){let t=a.subscribe("anuncios",s=>{this.renderAnuncios(s)}),e=a.subscribe("loading",s=>{this.updateLoadingState(s.anuncios)}),i=a.subscribe("errors",s=>{s.anuncios&&this.showError(s.anuncios)});this.unsubscribers.push(t,e,i)}async loadInitialData(){await this.loadAnuncios()}async loadAnuncios(){a.setLoading("anuncios",!0);try{let t={};this.filters.tipo!=="TODOS"&&(t.tipo=this.filters.tipo);let e=await u.getAnuncios(t);a.set("anuncios",e.anuncios||[])}catch(t){a.setError("anuncios",t.message)}finally{a.setLoading("anuncios",!1)}}handleClick(t){let e=t.target;if(e.id==="nuevo-anuncio-btn")t.preventDefault(),this.showNuevoAnuncioModal();else if(e.closest('[data-action="edit-anuncio"]')){t.preventDefault();let s=e.closest('[data-action="edit-anuncio"]').dataset.id;this.editAnuncio(s)}else if(e.closest('[data-action="delete-anuncio"]')){t.preventDefault();let s=e.closest('[data-action="delete-anuncio"]').dataset.id;this.deleteAnuncio(s)}else(e.classList.contains("close")||e.classList.contains("modal-cancel"))&&(t.preventDefault(),this.closeModals())}handleChange(t){t.target.id==="anuncios-tipo"&&this.updateFilters()}handleSubmit(t){let e=t.target;e.id==="anuncio-form"&&(t.preventDefault(),this.submitAnuncio(e))}updateFilters(){this.filters={tipo:document.getElementById("anuncios-tipo")?.value||"TODOS"},console.log("Filters updated:",this.filters),this.loadAnuncios()}renderAnuncios(t){let e=document.getElementById("anuncios-list");if(!e)return;if(!t||t.length===0){e.innerHTML='<p class="text-center">No hay anuncios disponibles</p>';return}let i=document.createDocumentFragment();t.forEach(s=>{let n=this.createAnuncioCard(s);i.appendChild(n)}),e.innerHTML="",e.appendChild(i)}createAnuncioCard(t){let e=document.createElement("div");e.className="anuncio-card";let i=this.getTipoClass(t.tipo),s=new Date(t.fechaPublicacion||t.createdAt).toLocaleDateString("es-MX");return e.innerHTML=`
      <div class="anuncio-header">
        <div>
          <h4>${t.titulo}</h4>
          <span class="badge ${i}">${t.tipo}</span>
        </div>
        <div class="anuncio-actions">
          <button class="btn btn-sm btn-secondary" data-action="edit-anuncio" data-id="${t.id}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-danger" data-action="delete-anuncio" data-id="${t.id}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      <div class="anuncio-body">
        <p>${t.contenido}</p>
      </div>
      <div class="anuncio-footer">
        <small>Publicado: ${s}</small>
        ${t.activo?'<span class="badge badge-success">Activo</span>':'<span class="badge badge-secondary">Inactivo</span>'}
      </div>
    `,e}getTipoClass(t){return{URGENTE:"badge-danger",IMPORTANTE:"badge-warning",GENERAL:"badge-info",REUNION:"badge-primary",MANTENIMIENTO:"badge-secondary"}[t]||"badge-secondary"}showNuevoAnuncioModal(){let t=document.getElementById("anuncio-modal");if(!t)return;let e=document.getElementById("anuncio-form");e&&(e.reset(),document.getElementById("anuncio-id").value="",document.getElementById("anuncio-modal-title").textContent="Nuevo Anuncio"),t.style.display="block"}editAnuncio(t){let i=a.get("anuncios").find(n=>n.id===parseInt(t));if(!i){alert("Anuncio no encontrado");return}let s=document.getElementById("anuncio-modal");s&&(document.getElementById("anuncio-id").value=i.id,document.getElementById("anuncio-titulo").value=i.titulo,document.getElementById("anuncio-tipo").value=i.tipo,document.getElementById("anuncio-contenido").value=i.contenido,document.getElementById("anuncio-modal-title").textContent="Editar Anuncio",s.style.display="block")}async deleteAnuncio(t){if(confirm("\xBFEst\xE1 seguro de eliminar este anuncio?"))try{await u.request(`/anuncios/${t}`,{method:"DELETE",cache:!1}),alert("Anuncio eliminado exitosamente"),this.loadAnuncios()}catch(e){alert(`Error: ${e.message}`)}}async submitAnuncio(t){let e=new FormData(t),i=e.get("anuncio-id"),s={titulo:e.get("titulo"),tipo:e.get("tipo"),contenido:e.get("contenido"),activo:!0};try{i?(await u.request(`/anuncios/${i}`,{method:"PUT",body:s,cache:!1}),alert("Anuncio actualizado exitosamente")):(await u.createAnuncio(s),alert("Anuncio creado exitosamente")),this.closeModals(),this.loadAnuncios()}catch(n){alert(`Error: ${n.message}`)}}closeModals(){document.querySelectorAll(".modal").forEach(t=>{t.style.display="none"})}updateLoadingState(t){let e=document.getElementById("anuncios-section");e&&(t?e.classList.add("loading"):e.classList.remove("loading"))}showError(t){console.error("Anuncios error:",t)}cleanup(){console.log("\u{1F9F9} Cleaning up Anuncios module..."),this.unsubscribers.forEach(t=>t()),this.unsubscribers=[],this.initialized=!1}},v=new h;export{v as default};
